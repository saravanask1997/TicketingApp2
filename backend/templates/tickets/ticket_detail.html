{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}{{ ticket.title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-ticket-detailed"></i> {{ ticket.title }}
    </h1>
    <div class="btn-toolbar">
        {% if user.is_admin or user.is_automation_team %}
            <div class="btn-group me-2">
                <a href="{% url 'tickets:edit' ticket.id %}" class="btn btn-outline-primary">
                    <i class="bi bi-pencil"></i> Edit Ticket
                </a>
            </div>
        {% endif %}
        <div class="btn-group">
            <button class="btn btn-outline-secondary" data-print>
                <i class="bi bi-printer"></i> Print
            </button>
        </div>
    </div>
</div>

<!-- Ticket Information -->
<div class="row">
    <div class="col-md-8">
        <!-- Main Ticket Details -->
        <div class="card shadow mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Ticket Details</h5>
                <div>
                    <span class="badge bg-{{ ticket.priority|yesno:'success,info,warning,danger' }} me-2">
                        {{ ticket.get_priority_display }}
                    </span>
                    <span class="badge bg-{{ ticket.status|yesno:'warning,info,success,secondary' }}">
                        {{ ticket.get_status_display }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Ticket ID:</strong> {{ ticket.id }}
                    </div>
                    <div class="col-md-6">
                        <strong>Category:</strong> {{ ticket.get_category_display }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Created By:</strong>
                        {{ ticket.created_by.get_full_name|default:ticket.created_by.email }}
                        {% if ticket.created_by.department %}
                            <span class="text-muted">({{ ticket.created_by.department }})</span>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <strong>Assigned To:</strong>
                        {% if ticket.assigned_to %}
                            {{ ticket.assigned_to.get_full_name|default:ticket.assigned_to.email }}
                        {% else %}
                            <span class="text-muted">Unassigned</span>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Created:</strong> {{ ticket.created_at|date:"M d, Y g:i A" }}
                    </div>
                    <div class="col-md-6">
                        <strong>Last Updated:</strong> {{ ticket.updated_at|date:"M d, Y g:i A" }}
                    </div>
                </div>

                {% if ticket.due_date %}
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Due Date:</strong>
                        {{ ticket.due_date|date:"M d, Y" }}
                        {% if ticket.is_overdue %}
                            <span class="badge bg-danger">Overdue</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if ticket.closed_at %}
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Closed:</strong> {{ ticket.closed_at|date:"M d, Y g:i A" }}
                    </div>
                    {% if ticket.resolution_time %}
                    <div class="col-md-6">
                        <strong>Resolution Time:</strong> {{ ticket.resolution_time|floatformat:1 }} hours
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <hr>

                <h6>Description</h6>
                <div class="bg-light p-3 rounded">
                    {{ ticket.description|linebreaks }}
                </div>

                {% if ticket.tags %}
                <div class="mt-3">
                    <strong>Tags:</strong>
                    {% for tag in ticket.tags %}
                        <span class="badge bg-secondary">{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Admin/Automation Team Actions -->
        {% if user.is_admin or user.is_automation_team %}
        <div class="card shadow mb-4">
            <div class="card-header">
                <h6 class="mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Assignment Form -->
                    <div class="col-md-6">
                        <form method="post" action="{% url 'tickets:assign' ticket.id %}" class="mb-3">
                            {% csrf_token %}
                            <div class="row align-items-end">
                                <div class="col">
                                    <label class="form-label">Assign To:</label>
                                    {{ assignment_form.assigned_to|add_class:"form-select" }}
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="bi bi-person-plus"></i> Assign
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Status Update Form -->
                    <div class="col-md-6">
                        <form method="post" action="{% url 'tickets:update_status' ticket.id %}" class="mb-3">
                            {% csrf_token %}
                            <div class="row align-items-end">
                                <div class="col">
                                    <label class="form-label">Update Status:</label>
                                    {{ status_form.status|add_class:"form-select" }}
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="bi bi-arrow-repeat"></i> Update
                                    </button>
                                </div>
                            </div>
                            {{ status_form.status_notes|add_class:"form-control mt-2"|attr:"placeholder:Add notes about this status change" }}
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Comments Section -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-chat-dots"></i> Comments & Communication
                </h6>
            </div>
            <div class="card-body">
                <!-- Add Comment Form -->
                <form method="post" action="{% url 'tickets:add_comment' ticket.id %}" class="mb-4">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Add Comment:</label>
                        {{ comment_form.content|add_class:"form-control"|attr:"rows:3"|attr:"placeholder:Add your comment..." }}
                    </div>
                    {% if comment_form.comment_type %}
                        <div class="mb-3">
                            <label class="form-label">Comment Type:</label>
                            {{ comment_form.comment_type|add_class:"form-select" }}
                            <small class="text-muted">
                                <strong>Public:</strong> Visible to ticket creator and team<br>
                                <strong>Internal:</strong> Only visible to admin and automation team
                            </small>
                        </div>
                    {% endif %}
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i> Add Comment
                    </button>
                </form>

                <!-- Comments List -->
                {% for comment in comments %}
                <div class="border-start ps-3 mb-3 {% if comment.comment_type == 'internal' %}border-warning{% endif %}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>
                                {{ comment.author.get_full_name|default:comment.author.email }}
                                {% if comment.comment_type == 'internal' %}
                                    <span class="badge bg-warning">Internal Note</span>
                                {% endif %}
                            </strong>
                            <small class="text-muted">- {{ comment.created_at|date:"M d, Y g:i A" }}</small>
                        </div>
                        {% if comment.updated_at != comment.created_at %}
                            <small class="text-muted"><i class="bi bi-pencil"></i> Edited</small>
                        {% endif %}
                    </div>
                    <div class="mt-2">
                        {{ comment.content|linebreaks }}
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted py-3">
                    <i class="bi bi-chat-dots" style="font-size: 2rem;"></i>
                    <p class="mt-2">No comments yet. Be the first to add one!</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Status History -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history"></i> Status History
                </h6>
            </div>
            <div class="card-body">
                {% for history in status_history %}
                <div class="d-flex align-items-start mb-3">
                    <div class="me-2">
                        <i class="bi bi-arrow-right-circle text-primary"></i>
                    </div>
                    <div class="flex-grow-1">
                        <small class="text-muted">{{ history.changed_at|date:"M d, Y g:i A" }}</small>
                        <div>
                            {% if history.old_status %}
                                <span class="badge bg-secondary">{{ history.old_status|title }}</span>
                                â†’
                            {% endif %}
                            <span class="badge bg-primary">{{ history.new_status|title }}</span>
                        </div>
                        {% if history.changed_by %}
                            <small>by {{ history.changed_by.get_full_name|default:history.changed_by.email }}</small>
                        {% endif %}
                        {% if history.notes %}
                            <div class="small text-muted mt-1">{{ history.notes }}</div>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted py-3">
                    <i class="bi bi-clock-history" style="font-size: 1.5rem;"></i>
                    <p class="mt-2">No status changes yet</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Ticket Actions -->
        <div class="card shadow">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-lightning"></i> Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'tickets:my_tickets' %}" class="btn btn-outline-primary">
                        <i class="bi bi-list"></i> My Tickets
                    </a>
                    {% if user.is_admin or user.is_automation_team %}
                        <a href="{% url 'tickets:list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-grid"></i> All Tickets
                        </a>
                        <a href="{% url 'tickets:create' %}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Create New Ticket
                        </a>
                    {% endif %}
                    <a href="{% url 'users:profile' %}" class="btn btn-outline-info">
                        <i class="bi bi-person"></i> My Profile
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}